<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>My Baking Timer</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#c9a574">

<link rel="icon" type="image/png" href="breadroll.png"/>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
html, body {
  height: 100%; margin: 0;
  display: flex; flex-direction: column;
  font-family: 'Poppins', sans-serif;
  background: linear-gradient(180deg, #faf7f2, #f2e7dc);
  color: #2e2e2e;
}
header {
  background: linear-gradient(90deg, #e6d5c3, #c9a574);
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  position: sticky; top: 0; z-index: 100;
}
.navbar { display:flex; align-items:center; justify-content:space-between; max-width:1200px; margin:0 auto; padding:0.4rem 1.5rem;}
.navbar .logo img { height:45px; }
.navbar .links { display:flex; gap:2rem; flex-wrap:wrap; }
.navbar .links a { position:relative; text-decoration:none; font-weight:500; color:#2e2e2e; padding-bottom:2px; transition:color 0.3s; font-size:0.95rem; }
.navbar .links a::after { content:""; position:absolute; width:0%; height:2px; bottom:0; left:0; background-color:#6b4b2c; transition:width 0.3s ease; }
.navbar .links a:hover::after, .navbar .links a.active::after { width:100%; }
.navbar .links a.active { color:#6b4b2c; }
.navbar .links button { padding:0.2rem 0.5rem; background:linear-gradient(90deg, #a6e4a0, #f3604d); color:#fff; font-weight:500; border-radius:50px; text-decoration:none; font-size:0.85rem; align-items:center; justify-content:center; transition: background 0.3s, transform 0.2s; }
.navbar .links button:hover { background:linear-gradient(90deg, #96eb78, #3164f1); transform: scale(1.05); }
.navbar .actions .btn { padding:0.4rem 1rem; background:linear-gradient(90deg, #6b4b2c, #4a3320); color:#fff; font-weight:600; border-radius:50px; text-decoration:none; font-size:0.85rem; display:inline-flex; align-items:center; justify-content:center; transition: background 0.3s, transform 0.2s; }
.navbar .actions .btn:hover { background:linear-gradient(90deg, #4a3320, #2e1f12); transform: scale(1.05); }

main { flex:1; display:flex; flex-direction:column; align-items:center; padding:2rem; background:#f5ede2; }
#timersWrapper { display:flex; flex-wrap:wrap; gap:20px; justify-content:center; width:100%; max-width: 1200px; }
.timer-container { text-align:center; max-width:420px; width:100%; padding:2rem; background:rgba(255,255,255,0.85); border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,0.08); backdrop-filter:blur(6px); animation: fadeIn 0.8s ease; }
.timer-row{display:flex;gap:.5rem;align-items:center;justify-content:center; flex-wrap: wrap;}
.timer-row input.timerName,
.timer-row select.soundSelect{flex: 1 1 150px; min-width: 120px; box-sizing: border-box; padding:8px;border-radius:8px;border:2px solid #ccc;background:#fff;font-size:.95rem}
.timer-row input.timerName:focus, .timer-row select.soundSelect:focus{border-color:#b85c38}

.timer-container h2 { margin-bottom:15px; font-size:1.5rem; color:#6b4b2c; }
/* .timer-container input.timerName { width:100%; margin-bottom:10px; padding:6px 10px; font-size:1rem; border:2px solid #ccc; border-radius:8px; outline:none; text-align:center; box-sizing:border-box; } */
/* .timer-container input.timerName:focus { border-color:#b85c38; } */
/* .timer-container select.soundSelect {
  margin-bottom: 10px;
  padding: 6px 10px;
  font-size: 0.95rem;
  border-radius: 8px;
  border: 2px solid #ccc;
  outline: none;
  width: 100%;
  background-color: #fff;
  color: #333;
} */
.soundSelect:focus { border-color:#b85c38; }

.timeDisplay { font-size:3rem; font-weight:bold; margin:15px 0; color:#b85c38; }

.input-group {
  display: flex;
  justify-content: center;
  gap: 15px;
  margin-bottom: 15px;
  flex-wrap: wrap;
}
.time-input {
  display: flex;
  flex-direction: column;
  align-items: center;
  min-width: 70px;
}
.time-input input {
  width: 70px;
  text-align: center;
  font-size: 1rem;
  padding: 6px;
  border-radius: 8px;
  border: 2px solid #ccc;
  outline: none;
  margin-top:5px;
}
.time-input button {
  width: 70px;
  padding: 8px 0;
  font-weight: 700;
  font-size: 1rem;
  cursor: pointer;
  border-radius: 10px;
  border: 1px solid #999;
  background: linear-gradient(145deg, #f0d9b5, #caa885);
  color: #3e2f1c;
  box-shadow: 2px 2px 5px rgba(0,0,0,0.15), -2px -2px 5px rgba(255,255,255,0.6);
  user-select: none;
  transition: transform 0.15s, box-shadow 0.15s;
}
.time-input button:hover {
  transform: scale(1.05);
  box-shadow: 3px 3px 6px rgba(0,0,0,0.2), -3px -3px 6px rgba(255,255,255,0.7);
}
.time-input .decBtn {
  margin-top:5px;
  background: linear-gradient(145deg, #caa885, #f0d9b5);
}

.time-input button:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

.timer-controls { display:flex; justify-content:center; gap:10px; flex-wrap:wrap; margin-top:10px; }
.timer-controls button { padding:8px 16px; border:none; border-radius:10px; color:#fff; cursor:pointer; font-size:0.95rem; font-weight:600; transition: transform 0.2s, opacity 0.2s; }
.startBtn { background:#3cb371; } .pauseBtn { background:#ffa500; } .resetBtn { background:#d9534f; } .closeBtn { background:#888; }
.timer-controls button:hover { transform:scale(1.05); opacity:0.9; }

#addTimerBtn { margin-bottom:20px; padding:10px 20px; border:none; border-radius:50px; font-weight:600; cursor:pointer; background:linear-gradient(90deg,#3cb371,#2e8b57); color:#fff; transition:transform 0.2s; }
#addTimerBtn:hover { transform:scale(1.05); }

footer { text-align:center; background:linear-gradient(90deg, #e6d5c3, #c9a574); color:#2e2e2e; padding:0.5rem 0; font-size:0.75rem; margin-top:auto; }
.mobile-nav { position:fixed; bottom:34px; left:50%; transform:translateX(-50%); background:linear-gradient(90deg, #6b4b2c, #4a3320); color:#fff !important; font-weight:700; text-shadow:1px 1px 2px rgba(0,0,0,0.3); padding:0.75rem 1.4rem; border-radius:50px; text-decoration:none; font-size:0.75rem; box-shadow:0 4px 8px rgba(0,0,0,0.25); z-index:999; transition: transform 0.2s, opacity 0.2s; }
.mobile-nav a:visited { color:#fff !important; }
.mobile-nav:hover { transform:translateX(-50%) scale(1.05); opacity:0.9; }

@media (min-width:769px) { .mobile-nav { display:none; } }
@media (max-width:768px) {
  .navbar .links { gap:1.2rem; } 
  .navbar .links a { font-size:0.85rem; } 
  /* .navbar .links button { padding:0.2rem 0.5rem; background:linear-gradient(90deg, #a6e4a0, #f3604d); color:#fff; font-weight:600; border-radius:50px; text-decoration:none; font-size:0.85rem; align-items:center; justify-content:center; transition: background 0.3s, transform 0.2s; }
  .navbar .links button:hover { background:linear-gradient(90deg, #d5eecc, #54eb6d); transform: scale(1.05); } */
  .navbar .actions { display:none; }
  .timer-container { max-width:100%; padding:1rem; }
  .timeDisplay { font-size:2rem; margin:10px 0; }
  .time-input input { width:60px; }
  .time-input button { width:60px; font-size:0.85rem; }
}

@media (max-width: 480px) {
  .timer-row input.timerName {
    max-width: 55%;
  }
  .timer-row select.soundSelect {
    max-width: 40%;
  }
}


@keyframes fadeIn { from {opacity:0; transform:translateY(20px);} to {opacity:1; transform:translateY(0);} }

.toast {
  position: fixed;
  bottom: 20px;
  right: 10px;
  background: #6b4b2c;
  color: #fff;
  padding: 6px 9px;
  border-radius: 8px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.3);
  opacity: 0;
  transform: translateY(20px);
  transition: opacity 0.4s, transform 0.4s;
  z-index: 9999;
  font-weight: 500;
  font-size: small;
}
.toast.show {
  opacity: 1;
  transform: translateY(0);
}

/* ---------- Bell icon animation ---------- */
.bell {
  display: inline-block;
  margin-left: 6px;
  font-size: 1.4em;
  transform-origin: top center;
}

/* When timer finishes */
.bell.ringing {
  animation: bellRing 0.25s infinite ease-in-out;
}

@keyframes bellRing {
  0%   { transform: rotate(0deg); }
  25%  { transform: rotate(25deg); }
  50%  { transform: rotate(0deg); }
  75%  { transform: rotate(-25deg); }
  100% { transform: rotate(0deg); }
}




</style>
</head>
<body>
<header>
  <div class="navbar">
    <div class="logo"><a href="./index.html"><img src="logo4.png" alt="KCSR Breads Logo" /></a></div>
    <nav class="links">
      <a href="./index.html">Home</a>
      <a href="./about.html">About Us</a>
      <a href="./timer.html" class="active">My Baking Timer</a>
      <button id="installBtn" style="display:none;">üì≤</button>
    </nav>
    <div class="actions"><a href="./index.html" class="btn">üõí Shop Now</a>
    </div>
  </div>
</header>

<main>
  <button id="addTimerBtn">‚ûï Add Timer</button>

  <div id="timersWrapper">
    <div class="timer-container">
       <div class="timer-row">
      <input type="text" class="timerName" placeholder="Optional: Timer Name">
      <select class="soundSelect">
        <option value="sounds/alarmdigital.mp3">Digital Beep</option>
        <option value="sounds/huntrix_golden.mp3">Huntrix</option>
        <option value="sounds/SodaPop.mp3">Soda</option>
        <option value="sounds/timer1.mp3">Timer 1</option>
        <option value="sounds/timer2.mp3">Timer 2</option>
        <option value="sounds/timer3.mp3">Timer 3</option>
      </select>
      </div>

      <h2>‚è≤Ô∏è My Baking Timer 1</h2>

      <div class="input-group">
        <div class="time-input">
          <button class="incBtn">HR</button>
          <input type="number" class="hoursInput" min="0" max="23" value="0">
          <button class="decBtn">‚ñº</button>
        </div>
        <div class="time-input">
          <button class="incBtn">MIN</button>
          <input type="number" class="minutesInput" min="0" max="59" value="0">
          <button class="decBtn">‚ñº</button>
        </div>
        <div class="time-input">
          <button class="incBtn">SEC</button>
          <input type="number" class="secondsInput" min="0" max="59" value="0">
          <button class="decBtn">‚ñº</button>
        </div>
      </div>

      <div class="timeDisplay">00:00:00</div>

      <div class="timer-controls">
        <button class="startBtn">‚ñ∂ Start</button>
        <button class="pauseBtn">‚è∏ Pause</button>
        <button class="resetBtn">‚èπ Stop/Reset</button>
        <button class="closeBtn">‚ùå Close</button>
      </div>
    </div>
  </div>

  <!-- <div class="actions">
    <button id="installBtn" style="display:none;" class="btn">üì≤ Install App</button>
  </div> -->

</main>

<footer>&copy; 2025 KCSR Breads atbp. All rights reserved.</footer>
<nav id="mobileNav" class="mobile-nav">
  <a href="./index.html">üßÅ Get Baked Goodies</a>
</nav>

<audio id="dingSound" preload="auto">
  <source src="/breads/sounds/alarmdigital.mp3" type="audio/mpeg">
</audio>

<script>

// global object to track any currently playing audio per timer
const activeAudios = new Map();

// ‚úÖ Preload all sound files once
const soundPaths = [
  "/breads/sounds/alarmdigital.mp3",
  "/breads/sounds/huntrix_golden.mp3",
  "/breads/sounds/SodaPop.mp3",
  "/breads/sounds/timer1.mp3",
  "/breads/sounds/timer2.mp3",
  "/breads/sounds/timer3.mp3"
];

const preloadedAudios = {};
soundPaths.forEach(path => {
  const audio = new Audio(path);
  audio.preload = "auto";
  preloadedAudios[path] = audio;
});

function playAlarmSound(timerId, soundUrl, bellElem) {
  stopAlarmSound(timerId);

  const audio = preloadedAudios[soundUrl] 
    ? preloadedAudios[soundUrl].cloneNode(true)  // reuse preloaded buffer
    : new Audio(soundUrl);

  audio.preload = "auto";
  audio.loop = true;
  audio.volume = 1.0;
  audio.muted = false;

  audio.play().catch(() => {
    showToast("‚ö†Ô∏è Sound unavailable offline. Please reconnect once.");
    /* ignore autoplay block */});
  activeAudios.set(timerId, audio);

  if (bellElem) bellElem.classList.add("ringing");
  return audio;
}


function stopAlarmSound(timerId) {
  const audio = activeAudios.get(timerId);
  if (audio) {
    try {
      audio.pause();
      audio.currentTime = 0;
      audio.loop = false;
    } catch(e){}
  }
  activeAudios.delete(timerId);
}

/* ---------- Quick helpers ---------- */
const playSilentUnlock = () => {
  // Unlock audio on first interaction (some mobile browsers require it)
  const ding=document.getElementById('dingSound');
  ding.play().then(()=>{ 
    ding.pause(); 
    ding.currentTime=0; 
  }).catch(()=>{});
};
document.body.addEventListener('click', playSilentUnlock, { once: true });

// const dingSound = document.getElementById("dingSound");
// document.body.addEventListener("click", () => { 
//   dingSound.play().then(() => { dingSound.pause(); dingSound.currentTime=0; }).catch(() => {}); 
// }, { once: true });

let timerCount = 1;

let toastOffset = 0;
function showToast(msg, withStopButton = false, audio = null, timerId = null) {
  const toast = document.createElement("div");
  toast.className = "toast";
  toast.style.left = "50%";
  toast.style.transform = "translateX(-50%)";
  toast.style.bottom = `${20 + toastOffset}px`;

  if (withStopButton && audio) {
    toast.innerHTML = `
      <span>${msg}</span>
      <button style="
        background: linear-gradient(90deg, #c0392b, #e74c3c);
        color: #fff;
        border: none;
        padding: 6px 14px;
        border-radius: 20px;
        margin-left: 12px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.85rem;
        box-shadow: 0 2px 6px rgba(0,0,0,0.25);
        transition: transform 0.2s ease, opacity 0.2s ease;
      ">Stop</button>
    `;

    const stopBtn = toast.querySelector("button");
    stopBtn.addEventListener("click", () => {
      try {
        audio.pause();
        audio.currentTime = 0;
        audio.loop = false;
      } catch(e){}
      if (timerId !== null) stopAlarmSound(timerId);
      toast.remove();
      showToast("‚úÖ Sound stopped.");
    });

    stopBtn.addEventListener("mouseenter", () => {
      stopBtn.style.transform = "scale(1.05)";
      stopBtn.style.opacity = "0.9";
    });
    stopBtn.addEventListener("mouseleave", () => {
      stopBtn.style.transform = "scale(1)";
      stopBtn.style.opacity = "1";
    });
  } else {
    toast.textContent = msg;
  }

  document.body.appendChild(toast);
  requestAnimationFrame(() => toast.classList.add("show"));

  setTimeout(() => {
    toast.classList.remove("show");
    setTimeout(() => toast.remove(), 400);
  }, 4000);

  toastOffset += 70;
  setTimeout(() => (toastOffset = Math.max(0, toastOffset - 70)), 4000);
}




function createTimer(container, number){
  let timer = null;
  let totalSeconds = 0;
  let running = false;
  let resetClickedOnce = false;

  const timerNameInput = container.querySelector(".timerName");
  const hoursInput = container.querySelector(".hoursInput");
  const minutesInput = container.querySelector(".minutesInput");
  const secondsInput = container.querySelector(".secondsInput");
  const timeDisplay = container.querySelector(".timeDisplay");
  const startBtn = container.querySelector(".startBtn");
  const pauseBtn = container.querySelector(".pauseBtn");
  const resetBtn = container.querySelector(".resetBtn");
  const closeBtn = container.querySelector(".closeBtn");
  const soundSelect = container.querySelector(".soundSelect");

  // label/title + bell in header
  const defaultName = `Timer ${number}`;
  const title = container.querySelector("h2");
  if (title) {
    title.innerHTML = `‚è≤Ô∏è <span class="timer-label">${defaultName}</span> <span class="bell">üîî</span>`;
  }

  // Keep the chosen sound src in a variable. We'll create a fresh Audio when playing.
  let selectedSound = soundSelect ? soundSelect.value : null;

  // reference to the currently-playing alarm Audio for this timer (if any)
  let alarmAudio = null;

  // Update header when timer name changes (keep bell)
  timerNameInput.addEventListener('input', () => {
    const h2 = container.querySelector("h2");
    const name = timerNameInput.value || defaultName;
    if (h2) h2.innerHTML = `‚è≤Ô∏è ${name} <span class="bell">üîî</span>`;
  });

  // Update selected sound when user changes dropdown
  if (soundSelect) {
    soundSelect.addEventListener('change', () => {
      selectedSound = soundSelect.value;
      // optional: warm-up preload using existing preloadedAudios if present
      if (preloadedAudios && preloadedAudios[selectedSound]) {
        // nothing else needed ‚Äî file is cached/preloaded
      }
    });
  }

  // Update time display from inputs or totalSeconds
  function updateDisplay(){
    let dispH, dispM, dispS;

    if(running || totalSeconds > 0){
      dispH = Math.floor(totalSeconds / 3600);
      dispM = Math.floor((totalSeconds % 3600) / 60);
      dispS = totalSeconds % 60;
    } else {
      const h = parseInt(hoursInput.value) || 0;
      const m = parseInt(minutesInput.value) || 0;
      const s = parseInt(secondsInput.value) || 0;
      dispH = h; dispM = m; dispS = s;
    }

    timeDisplay.textContent = `${dispH.toString().padStart(2,"0")}:${dispM.toString().padStart(2,"0")}:${dispS.toString().padStart(2,"0")}`;

    // Disable decrement buttons if at min
    container.querySelectorAll(".time-input").forEach(ti=>{
      const input = ti.querySelector("input");
      const decBtn = ti.querySelector(".decBtn");
      if (input && decBtn) decBtn.disabled = parseInt(input.value) <= parseInt(input.min);
    });
  }

  // stop and cleanup alarm audio for this timer
  function stopAlarmAudio() {
    if (alarmAudio) {
      try {
        alarmAudio.pause();
        alarmAudio.currentTime = 0;
        alarmAudio.loop = false;
      } catch(e) { /* ignore */ }
      alarmAudio = null;
    }
    const bell = container.querySelector(".bell");
    if (bell) bell.classList.remove("ringing");
  }

  // Increment/decrement buttons
  container.querySelectorAll(".incBtn, .decBtn").forEach(btn=>{
    let interval;
    const input = btn.closest(".time-input").querySelector("input");
    const step = btn.classList.contains("incBtn") ? 1 : -1;
    const min = parseInt(input.min);
    const max = parseInt(input.max);

    const change = () => {
      let val = parseInt(input.value) || 0;
      val += step;
      val = Math.min(max, Math.max(min, val));
      input.value = val;
      updateDisplay();
    };

    btn.addEventListener("mousedown", ()=>{ change(); interval=setInterval(change,150); });
    btn.addEventListener("mouseup", ()=>clearInterval(interval));
    btn.addEventListener("mouseleave", ()=>clearInterval(interval));
    btn.addEventListener("touchstart", e=>{ e.preventDefault(); change(); interval=setInterval(change,150); }, {passive:false});
    btn.addEventListener("touchend", ()=>clearInterval(interval));
  });

  // START button (handles countdown and stopwatch)
  startBtn.addEventListener("click", () => {
    if(running) return;

    const h = parseInt(hoursInput.value) || 0;
    const m = parseInt(minutesInput.value) || 0;
    const s = parseInt(secondsInput.value) || 0;

    const isStopwatch = (h === 0 && m === 0 && s === 0);

    // Only initialize totalSeconds if first start or after full reset
    if(totalSeconds === 0 && !isStopwatch){
      totalSeconds = h*3600 + m*60 + s;
      if(totalSeconds <= 0) return alert("Please enter a valid time!");
    }

    running = true;

    timer = setInterval(() => {
      if(isStopwatch){
        totalSeconds++;
      } else {
        if(totalSeconds > 0){
          totalSeconds--;
        } else {
          clearInterval(timer);
          running = false;

          // Create a fresh Audio instance at play time so multiple timers can play simultaneously.
          const bell = container.querySelector(".bell");
          alarmAudio = playAlarmSound(number, selectedSound || (soundSelect ? soundSelect.value : ""), bell);

          const name = timerNameInput.value.trim() || defaultName;
          showToast(`‚è∞ ${name} done! Check your bread!`, true, alarmAudio, number);

          return;
        }
      }

      updateDisplay();
    }, 1000);
  });

  // PAUSE button
  pauseBtn.addEventListener("click", () => {
    running = false;
    clearInterval(timer);
  });

  // RESET button (1 click stop, 2 clicks full reset)
  resetBtn.addEventListener("click", () => {
    clearInterval(timer);
    running = false;

    // stop the alarmSound and bell immediately
    stopAlarmAudio();

    if(!resetClickedOnce){
      const name = timerNameInput.value.trim() || defaultName;
      showToast(`‚èπ ${name} stopped. Click again to reset.`);
      resetClickedOnce = true;
      setTimeout(()=>resetClickedOnce=false,4000);
      return;
    }

    // Full reset
    hoursInput.value = '0';
    minutesInput.value = '0';
    secondsInput.value = '0';
    totalSeconds = 0;
    updateDisplay();
    showToast("üîÅ Timer fully reset.");
    resetClickedOnce = false;
  });

  // CLOSE button
  if(closeBtn){
    closeBtn.addEventListener("click", () => {
      running=false;
      clearInterval(timer);

      // stop alarm and bell
      stopAlarmAudio();

      // remove container from DOM
      container.remove();
    });
  }

  // Initial display
  updateDisplay();
}





document.querySelectorAll(".timer-container").forEach((t)=>createTimer(t, timerCount++));

document.getElementById("addTimerBtn").addEventListener("click", ()=>{
  const timersWrapper=document.getElementById("timersWrapper");
  const newTimer=document.createElement("div");
  newTimer.className="timer-container";
  newTimer.innerHTML=`
    <div class="timer-row">
      <input type="text" class="timerName" placeholder="Optional: Timer Name">
      <select class="soundSelect" aria-label="Select sound">
        <option value="sounds/alarmdigital.mp3">Digital Beep</option>
        <option value="sounds/huntrix_golden.mp3">Huntrix</option>
        <option value="sounds/SodaPop.mp3">Soda</option>
        <option value="sounds/timer1.mp3">Timer 1</option>
        <option value="sounds/timer2.mp3">Timer 2</option>
        <option value="sounds/timer3.mp3">Timer 3</option>
      </select>
    </div>
    <h2></h2>
    <div class="input-group">
      <div class="time-input">
        <button class="incBtn">HR</button>
        <input type="number" class="hoursInput" min="0" max="23" value="0">
        <button class="decBtn">‚ñº</button>
      </div>
      <div class="time-input">
        <button class="incBtn">MIN</button>
        <input type="number" class="minutesInput" min="0" max="59" value="0">
        <button class="decBtn">‚ñº</button>
      </div>
      <div class="time-input">
        <button class="incBtn">SEC</button>
        <input type="number" class="secondsInput" min="0" max="59" value="0">
        <button class="decBtn">‚ñº</button>
      </div>
    </div>
    <div class="timeDisplay">00:00:00</div>
    <div class="timer-controls">
      <button class="startBtn">‚ñ∂ Start</button>
      <button class="pauseBtn">‚è∏ Pause</button>
      <button class="resetBtn">‚èπ Stop/Reset</button>
      <button class="closeBtn">‚ùå Close</button>
    </div>
  `;
  timersWrapper.appendChild(newTimer);

  createTimer(newTimer, timerCount++);
});

// ======= PWA INSTALL LOGIC (Redirect to Chrome + manual install) =======

let deferredPrompt;
const installBtn = document.getElementById("installBtn");
const APP_URL = "https://kcsrtreasures.github.io/breads/timer.html";

// Always show install button (for update/reinstall)
if (installBtn) installBtn.style.display = "inline-block";

// Detect in-app browsers (Facebook, Messenger, Instagram)
function isInAppBrowser() {
  const ua = navigator.userAgent || navigator.vendor || window.opera;
  return /FBAN|FBAV|Instagram|Messenger/i.test(ua);
}

// Detect standalone mode (already installed)
function isStandalone() {
  return window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone;
}

// Show manual install guide (only when needed)
function showManualInstallGuide() {
  const isAndroid = /Android/i.test(navigator.userAgent);
  if (isAndroid) {
    showToast("üìñ Tap ‚ãÆ (three dots) ‚Üí 'Add to Home screen' to install manually.");
  } else {
    showToast("üìñ Tap Share ‚Üí 'Add to Home Screen' to install manually.");
  }
}

// Catch Chrome‚Äôs beforeinstallprompt
window.addEventListener("beforeinstallprompt", (e) => {
  e.preventDefault();
  deferredPrompt = e;
  console.log("‚úÖ beforeinstallprompt fired");
  if (installBtn) installBtn.style.display = "inline-block";
  showToast("üì≤ You can install or update this app anytime using the install button!");
});

// Handle install button click
if (installBtn) {
  installBtn.addEventListener("click", async () => {
    // If already installed
    if (isStandalone()) {
      showToast("‚úÖ App is already installed! Reinstalling or updating...");
      // Force reinstall/update if available
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === "accepted") {
          showToast("üéâ Update started!");
        } else {
          showToast("‚ùå Update canceled.");
        }
        deferredPrompt = null;
      } else {
        showToast("üîÑ If an update is available, it will auto-refresh soon.");
      }
      return;
    }

    // If inside in-app browser (Facebook / Instagram / Messenger)
    if (isInAppBrowser()) {
      showToast("‚ö†Ô∏è Opening Chrome for installation...");
      setTimeout(() => {
        const isAndroid = /Android/i.test(navigator.userAgent);
        if (isAndroid) {
          // Open in Chrome using intent URL
          const intentURL = `intent://${APP_URL.replace(/^https?:\/\//, "")}#Intent;scheme=https;package=com.android.chrome;end`;
          window.location.href = intentURL;
        } else {
          // For iOS: open in Safari
          window.open(APP_URL, "_blank");
        }
      }, 1200);
      return;
    }

    // If install prompt available
    if (deferredPrompt) {
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      if (outcome === "accepted") {
        showToast("üéâ Installation started!");
        localStorage.setItem("pwaInstalled", "true");
      } else {
        showToast("‚ùå Installation dismissed.");
      }
      deferredPrompt = null;
      return;
    }

    // Otherwise show manual instructions
    showManualInstallGuide();
  });
}

// When app gets installed
window.addEventListener("appinstalled", () => {
  showToast("‚úÖ App installed successfully!");
  localStorage.setItem("pwaInstalled", "true");
  if (installBtn) installBtn.style.display = "inline-block"; // Keep visible for updates
});

// When page loads, make sure install button stays visible
window.addEventListener("load", () => {
  if (isStandalone()) {
    localStorage.setItem("pwaInstalled", "true");
  }
  if (installBtn) installBtn.style.display = "inline-block"; // Always visible
});



// ======= SERVICE WORKER REGISTER =======
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker
      .register("/breads/service-worker.js")
      .then((reg) => {
        console.log("‚úÖ Service Worker registered:", reg.scope);

        reg.onupdatefound = () => {
          const newSW = reg.installing;
          if (newSW) {
            newSW.onstatechange = () => {
              if (newSW.state === "installed" && navigator.serviceWorker.controller) {
                showToast("üîÑ New version available! Please refresh or reinstall the app.");
              }
            };
          }
        };
      })
      .catch((err) => console.log("‚ùå SW registration failed:", err));

    // Auto-reload when new service worker activates
    navigator.serviceWorker.addEventListener("controllerchange", () => {
      window.location.reload();
    });
  });
}




 
</script>
</body>
</html>
